<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MJD CRM">
    <meta name="theme-color" content="#1e40af">
    <title>MJD Home Improvement CRM</title>
    
    <!-- Embedded Manifest -->
    <script>
        const manifestData = {
            "name": "MJD Home Improvement CRM",
            "short_name": "MJD CRM",
            "description": "Complete contractor CRM for MJD Home Improvement",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#1e40af",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMzIiIGZpbGw9IiMxZTQwYWYiLz4KPHBhdGggZD0iTTQ4IDEyMGw0OC00OCA0OCA0OHYzMmgtOTZ2LTMyeiIgZmlsbD0iI2ZmZmZmZiIvPgo8cGF0aCBkPSJNNzIgMTM2aDQ4djE2SDcydi0xNnoiIGZpbGw9IiMxZTQwYWYiLz4KPHBhdGggZD0iTTk2IDQwdjMyaDE2VjQwSDk2eiIgZmlsbD0iI2ZmZmZmZiIvPgo8L3N2Zz4K",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iODQiIGZpbGw9IiMxZTQwYWYiLz4KPHBhdGggZD0iTTEyOCAzMjBsMTI4LTEyOCAxMjggMTI4djg0aC0yNTZ2LTg0eiIgZmlsbD0iI2ZmZmZmZiIvPgo8cGF0aCBkPSJNMTkyIDM2NGgxMjh2NDJIMTkydi00MnoiIGZpbGw9IiMxZTQwYWYiLz4KPHBhdGggZD0iTTI1NiAxMDZ2ODRoNDJWMTA2aC00MnoiIGZpbGw9IiNmZmZmZmYiLz4KPC9zdmc+Cg==",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };
        
        const blob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(blob);
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 20px 16px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            padding: 12px 16px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
            background: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .card-content {
            padding: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-full {
            width: 100%;
        }

        .grid {
            display: grid;
            gap: 16px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: skewX(-15deg) translateX(50%);
        }

        .stats-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }

        .stats-label {
            font-size: 12px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .progress-bar {
            background: #f1f5f9;
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1e40af 100%);
            transition: width 0.3s ease;
        }

        .client-card {
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin-bottom: 12px;
            background: #f8fafc;
            border-radius: 8px;
            position: relative;
        }

        .client-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
            transition: all 0.2s;
        }

        .client-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .client-info {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 2px;
        }

        .lead-score {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .lead-score-high {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .lead-score-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .lead-score-low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .cost-breakdown {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .cost-total {
            font-weight: 600;
            font-size: 16px;
            border-top: 1px solid #e2e8f0;
            padding-top: 8px;
            margin-top: 8px;
        }

        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1001;
        }

        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 100;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1002;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .appointment-card {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .time-slot {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            font-size: 12px;
            margin: 4px 4px 4px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .time-slot.booked {
            background: rgba(239, 68, 68, 0.3);
            cursor: not-allowed;
        }

        .estimate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .weather-widget {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }

        .search-bar input {
            padding-left: 40px;
        }

        .search-bar::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .filter-chip {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: #374151;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .task-checkbox {
            margin-right: 12px;
        }

        .task-content {
            flex: 1;
        }

        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 12px;
        }

        .priority-high {
            background: #ef4444;
        }

        .priority-medium {
            background: #f59e0b;
        }

        .priority-low {
            background: #10b981;
        }

        .expense-summary {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .expense-category {
            text-align: center;
        }

        .expense-amount {
            font-weight: 600;
            color: #1e293b;
        }

        .expense-label {
            font-size: 12px;
            color: #64748b;
        }

        .signature-pad {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: crosshair;
        }

        .timer-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 99;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .document-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }

        .rating-stars {
            color: #fbbf24;
        }

        .availability-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .available {
            background: #10b981;
        }

        .busy {
            background: #ef4444;
        }

        .preferred {
            background: #3b82f6;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>MJD Home Improvement CRM</h1>
            <p>CSL: CSFA-106473 | HIC: 198487 | (508)-902-7529</p>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('clients')">Clients</button>
            <button class="nav-tab" onclick="switchTab('leads')">Leads</button>
            <button class="nav-tab" onclick="switchTab('projects')">Projects</button>
            <button class="nav-tab" onclick="switchTab('invoices')">Invoices</button>
            <button class="nav-tab" onclick="switchTab('estimates')">Estimates</button>
            <button class="nav-tab" onclick="switchTab('scheduling')">Schedule</button>
            <button class="nav-tab" onclick="switchTab('tasks')">Tasks</button>
            <button class="nav-tab" onclick="switchTab('expenses')">Expenses</button>
            <button class="nav-tab" onclick="switchTab('timetracking')">Time</button>
            <button class="nav-tab" onclick="switchTab('documents')">Documents</button>
            <button class="nav-tab" onclick="switchTab('subcontractors')">Subs</button>
            <button class="nav-tab" onclick="switchTab('calculator')">Calculator</button>
            <button class="nav-tab" onclick="switchTab('team')">Team</button>
            <button class="nav-tab" onclick="switchTab('photos')">Photos</button>
            <button class="nav-tab" onclick="switchTab('inventory')">Inventory</button>
            <button class="nav-tab" onclick="switchTab('reports')">Reports</button>
            <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="weather-widget" id="weatherWidget">
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span style="font-size: 24px;">‚òÄÔ∏è</span>
                    <div>
                        <div style="font-weight: 600;">Worcester, MA</div>
                        <div style="font-size: 12px; opacity: 0.9;">Perfect weather for outdoor work</div>
                    </div>
                    <div style="font-size: 24px; font-weight: 700;">72¬∞F</div>
                </div>
            </div>
            
            <div class="grid grid-2">
                <div class="stats-card">
                    <div class="stats-number" id="totalClients">0</div>
                    <div class="stats-label">Total Clients</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="activeProjects">0</div>
                    <div class="stats-label">Active Projects</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="monthlyRevenue">$0</div>
                    <div class="stats-label">Monthly Revenue</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingInvoices">0</div>
                    <div class="stats-label">Pending Invoices</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Today's Schedule</h3>
                    <button class="btn btn-small btn-primary" onclick="openScheduleModal()">Add Appointment</button>
                </div>
                <div class="card-content" id="todaysSchedule">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>No appointments today</h3>
                        <p>Your schedule is clear!</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Recent Activity</h3>
                </div>
                <div class="card-content" id="recentActivity">
                    <p style="color: #64748b; text-align: center;">No recent activity</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Quick Tasks</h3>
                </div>
                <div class="card-content" id="quickTasks">
                    <div class="btn-group">
                        <button class="btn btn-primary btn-small" onclick="openClientModal()">Add Client</button>
                        <button class="btn btn-secondary btn-small" onclick="openLeadModal()">Add Lead</button>
                        <button class="btn btn-success btn-small" onclick="openInvoiceModal()">Create Invoice</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="clients" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Client Management</h3>
                    <button class="btn btn-primary" onclick="openClientModal()">Add New Client</button>
                </div>
                <div class="card-content">
                    <div class="search-bar">
                        <input type="text" class="form-input" id="clientSearch" placeholder="Search clients..." onkeyup="searchClients()">
                    </div>
                    <div id="clientsList" style="margin-top: 16px;">
                        <!-- Clients will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Leads Tab -->
        <div id="leads" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Lead Management</h3>
                    <button class="btn btn-primary" onclick="openLeadModal()">Add New Lead</button>
                </div>
                <div class="card-content">
                    <div class="filter-chips">
                        <div class="filter-chip active" data-status="all" onclick="filterLeads('all')">All Leads</div>
                        <div class="filter-chip" data-status="new" onclick="filterLeads('new')">New</div>
                        <div class="filter-chip" data-status="contacted" onclick="filterLeads('contacted')">Contacted</div>
                        <div class="filter-chip" data-status="qualified" onclick="filterLeads('qualified')">Qualified</div>
                    </div>
                    <div id="leadsList" style="margin-top: 16px;">
                        <!-- Leads will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Project Tracking</h3>
                    <button class="btn btn-primary" onclick="openProjectModal()">Create New Project</button>
                </div>
                <div class="card-content">
                    <div class="filter-chips">
                        <div class="filter-chip active" data-status="all" onclick="filterProjects('all')">All Projects</div>
                        <div class="filter-chip" data-status="planning" onclick="filterProjects('planning')">Planning</div>
                        <div class="filter-chip" data-status="in_progress" onclick="filterProjects('in_progress')">In Progress</div>
                        <div class="filter-chip" data-status="completed" onclick="filterProjects('completed')">Completed</div>
                    </div>
                    <div id="projectsList" style="margin-top: 16px;">
                        <!-- Projects will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Invoice Management</h3>
                    <button class="btn btn-primary" onclick="openInvoiceModal()">Create Invoice</button>
                </div>
                <div class="card-content">
                    <div class="filter-chips">
                        <div class="filter-chip active" data-status="all" onclick="filterInvoices('all')">All Invoices</div>
                        <div class="filter-chip" data-status="pending" onclick="filterInvoices('pending')">Pending</div>
                        <div class="filter-chip" data-status="paid" onclick="filterInvoices('paid')">Paid</div>
                        <div class="filter-chip" data-status="overdue" onclick="filterInvoices('overdue')">Overdue</div>
                    </div>
                    <div id="invoicesList" style="margin-top: 16px;">
                        <!-- Invoices will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Estimates Tab -->
        <div id="estimates" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Estimates & Quotes</h3>
                    <button class="btn btn-primary" onclick="openEstimateModal()">Create Estimate</button>
                </div>
                <div class="card-content">
                    <div id="estimatesList">
                        <!-- Estimates will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduling Tab -->
        <div id="scheduling" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Schedule Management</h3>
                    <button class="btn btn-primary" onclick="openScheduleModal()">Add Appointment</button>
                </div>
                <div class="card-content">
                    <div class="grid">
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                            <h4>Available Time Slots - Today</h4>
                            <div id="timeSlots" style="margin-top: 12px;">
                                <div class="time-slot">9:00 AM</div>
                                <div class="time-slot">10:00 AM</div>
                                <div class="time-slot">11:00 AM</div>
                                <div class="time-slot">1:00 PM</div>
                                <div class="time-slot">2:00 PM</div>
                                <div class="time-slot">3:00 PM</div>
                                <div class="time-slot">4:00 PM</div>
                            </div>
                        </div>
                    </div>
                    <div id="appointmentsList" style="margin-top: 16px;">
                        <!-- Appointments will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Task Management</h3>
                    <button class="btn btn-primary" onclick="openTaskModal()">Add Task</button>
                </div>
                <div class="card-content">
                    <div id="tasksList">
                        <!-- Tasks will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Tracking Tab -->
        <div id="timetracking" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Time Tracking</h3>
                    <button class="btn btn-primary" onclick="startTimeEntry()">Start Timer</button>
                </div>
                <div class="card-content">
                    <div id="activeTimer" style="display: none;">
                        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; margin-bottom: 16px;">
                            <div class="card-content">
                                <h3>Active Timer</h3>
                                <div style="font-size: 24px; font-weight: 700;" id="timerDisplay">00:00:00</div>
                                <div id="timerProject">No project selected</div>
                                <div style="margin-top: 12px;">
                                    <button class="btn btn-small" onclick="pauseTimer()" style="background: rgba(255,255,255,0.2);">Pause</button>
                                    <button class="btn btn-small" onclick="stopTimer()" style="background: rgba(255,255,255,0.2);">Stop</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-summary">
                        <div class="expense-category">
                            <div class="expense-amount" id="todayHours">0h</div>
                            <div class="expense-label">Today</div>
                        </div>
                        <div class="expense-category">
                            <div class="expense-amount" id="weekHours">0h</div>
                            <div class="expense-label">This Week</div>
                        </div>
                        <div class="expense-category">
                            <div class="expense-amount" id="monthHours">0h</div>
                            <div class="expense-label">This Month</div>
                        </div>
                    </div>
                    
                    <div class="filter-chips">
                        <div class="filter-chip active" onclick="filterTimeEntries('all')">All Entries</div>
                        <div class="filter-chip" onclick="filterTimeEntries('today')">Today</div>
                        <div class="filter-chip" onclick="filterTimeEntries('week')">This Week</div>
                    </div>
                    
                    <div id="timeEntriesList">
                        <!-- Time entries will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Document Management</h3>
                    <button class="btn btn-primary" onclick="openDocumentModal()">Upload Document</button>
                </div>
                <div class="card-content">
                    <div class="filter-chips">
                        <div class="filter-chip active" onclick="filterDocuments('all')">All Documents</div>
                        <div class="filter-chip" onclick="filterDocuments('contracts')">Contracts</div>
                        <div class="filter-chip" onclick="filterDocuments('permits')">Permits</div>
                        <div class="filter-chip" onclick="filterDocuments('photos')">Photos</div>
                        <div class="filter-chip" onclick="filterDocuments('invoices')">Invoices</div>
                    </div>
                    
                    <div id="documentsList">
                        <!-- Documents will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Subcontractors Tab -->
        <div id="subcontractors" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Subcontractor Management</h3>
                    <button class="btn btn-primary" onclick="openSubcontractorModal()">Add Subcontractor</button>
                </div>
                <div class="card-content">
                    <div class="search-bar">
                        <input type="text" class="form-input" id="subcontractorSearch" placeholder="Search subcontractors..." onkeyup="searchSubcontractors()">
                    </div>
                    
                    <div class="filter-chips">
                        <div class="filter-chip active" onclick="filterSubcontractors('all')">All Subs</div>
                        <div class="filter-chip" onclick="filterSubcontractors('available')">Available</div>
                        <div class="filter-chip" onclick="filterSubcontractors('busy')">Busy</div>
                        <div class="filter-chip" onclick="filterSubcontractors('preferred')">Preferred</div>
                    </div>
                    
                    <div id="subcontractorsList">
                        <!-- Subcontractors will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        <div id="expenses" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Expense Tracking</h3>
                    <button class="btn btn-primary" onclick="openExpenseModal()">Add Expense</button>
                </div>
                <div class="card-content">
                    <div class="expense-summary">
                        <div class="expense-category">
                            <div class="expense-amount" id="monthlyExpenses">$0</div>
                            <div class="expense-label">This Month</div>
                        </div>
                        <div class="expense-category">
                            <div class="expense-amount" id="yearlyExpenses">$0</div>
                            <div class="expense-label">This Year</div>
                        </div>
                        <div class="expense-category">
                            <div class="expense-amount" id="avgExpense">$0</div>
                            <div class="expense-label">Avg/Month</div>
                        </div>
                    </div>
                    <div id="expensesList">
                        <!-- Expenses will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Material Calculator</h3>
                </div>
                <div class="card-content">
                    <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label class="form-label">Project Type</label>
                            <select class="form-select" id="projectType" onchange="updateCalculator()">
                                <option value="deck">Deck</option>
                                <option value="kitchen">Kitchen Remodel</option>
                                <option value="bathroom">Bathroom Remodel</option>
                                <option value="siding">Siding</option>
                                <option value="roofing">Roofing</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Material Grade</label>
                            <select class="form-select" id="materialGrade" onchange="updateCalculator()">
                                <option value="standard">Standard</option>
                                <option value="premium">Premium</option>
                                <option value="luxury">Luxury</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Square Footage</label>
                            <input type="number" class="form-input" id="squareFootage" onchange="updateCalculator()" placeholder="Enter sq ft">
                        </div>
                        
                        <div class="cost-breakdown" id="costBreakdown">
                            <p style="color: #64748b;">Enter square footage to see cost breakdown</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="team" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Team Management</h3>
                    <button class="btn btn-primary" onclick="openTeamModal()">Add Team Member</button>
                </div>
                <div class="card-content">
                    <div id="teamList" style="margin-top: 16px;">
                        <!-- Team members will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Photos Tab -->
        <div id="photos" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Photo Management</h3>
                    <button class="btn btn-primary" onclick="document.getElementById('photoUpload').click()">Upload Photos</button>
                </div>
                <div class="card-content">
                    <input type="file" id="photoUpload" style="display: none;" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 16px;" id="photoGrid">
                        <div style="display: flex; align-items: center; justify-content: center; height: 120px; color: #64748b; font-size: 12px; text-align: center; background: #f1f5f9; border-radius: 8px;">No photos uploaded yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Inventory Management</h3>
                    <button class="btn btn-primary" onclick="openItemModal()">Add New Item</button>
                </div>
                <div class="card-content">
                    <div style="margin-bottom: 16px;">
                        <input type="text" class="form-input" id="inventorySearch" placeholder="Search items..." onkeyup="searchInventory()" style="margin-bottom: 12px;">
                        <select class="form-select" id="categoryFilter" onchange="filterInventory()" style="margin-bottom: 12px;">
                            <option value="">All Categories</option>
                            <option value="Labor">Labor</option>
                            <option value="Lumber">Lumber</option>
                            <option value="Tile">Tile</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Plumbing">Plumbing</option>
                            <option value="Paint">Paint</option>
                            <option value="Drywall">Drywall</option>
                            <option value="Doors & Windows">Doors & Windows</option>
                            <option value="Roofing">Roofing</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div id="inventoryList" style="margin-top: 16px;">
                        <!-- Inventory items will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Business Reports</h3>
                    <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                </div>
                <div class="card-content">
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-content">
                                <h4>Monthly Summary</h4>
                                <div class="stats-number" id="monthlyProjects">0</div>
                                <p>Projects Completed</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <h4>Revenue Growth</h4>
                                <div class="stats-number" id="revenueGrowth">+0%</div>
                                <p>vs Last Month</p>
                            </div>
                        </div>
                    </div>
                    <div id="reportsContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <h3>Generate your first report</h3>
                            <p>Click the button above to create a comprehensive business report</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Business Analytics</h3>
                </div>
                <div class="card-content">
                    <div style="height: 200px; background: #f8fafc; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #64748b; margin-bottom: 16px;">
                        Revenue Chart (Demo)
                    </div>
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-content">
                                <h4>Conversion Rate</h4>
                                <div class="stats-number">24%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 24%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <h4>Average Project Value</h4>
                                <div class="stats-number">$8,450</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAB Button -->
        <button class="fab" onclick="showQuickActions()">+</button>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Client</h3>
                <button class="modal-close" onclick="closeModal('clientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm" onsubmit="saveClient(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hourly Rate</label>
                        <input type="number" step="0.01" class="form-input" name="rate" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Skills</label>
                        <input type="text" class="form-input" name="skills" placeholder="e.g., Plumbing, Electrical, Carpentry">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Team Member</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Time Entry Modal -->
    <div id="timeEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Time Entry</h3>
                <button class="modal-close" onclick="closeModal('timeEntryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="timeEntryForm" onsubmit="saveTimeEntry(event)">
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" name="projectId" id="timeProjectSelect" required>
                            <option value="">Select project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <input type="text" class="form-input" name="description" required placeholder="What work was performed?">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hours</label>
                        <input type="number" step="0.25" class="form-input" name="hours" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team Member</label>
                        <select class="form-select" name="teamMember">
                            <option value="self">Myself</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hourly Rate</label>
                        <input type="number" step="0.01" class="form-input" name="rate" placeholder="$0.00">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Time Entry</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Document</h3>
                <button class="modal-close" onclick="closeModal('documentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="documentForm" onsubmit="saveDocument(event)">
                    <div class="form-group">
                        <label class="form-label">Document Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select type</option>
                            <option value="contracts">Contract</option>
                            <option value="permits">Permit</option>
                            <option value="photos">Photo</option>
                            <option value="invoices">Invoice</option>
                            <option value="estimates">Estimate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Related Client</label>
                        <select class="form-select" name="clientId" id="documentClientSelect">
                            <option value="">Select client (optional)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Related Project</label>
                        <select class="form-select" name="projectId" id="documentProjectSelect">
                            <option value="">Select project (optional)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Document Title</label>
                        <input type="text" class="form-input" name="title" required placeholder="e.g., Kitchen Remodel Contract">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Upload File</label>
                        <input type="file" class="form-input" name="file" accept="image/*,.pdf,.doc,.docx" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes about this document..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Upload Document</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Subcontractor Modal -->
    <div id="subcontractorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Subcontractor</h3>
                <button class="modal-close" onclick="closeModal('subcontractorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="subcontractorForm" onsubmit="saveSubcontractor(event)">
                    <div class="form-group">
                        <label class="form-label">Company/Name</label>
                        <input type="text" class="form-input" name="name" required placeholder="ABC Plumbing">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Person</label>
                        <input type="text" class="form-input" name="contact" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Specialty</label>
                        <select class="form-select" name="specialty" required>
                            <option value="">Select specialty</option>
                            <option value="plumbing">Plumbing</option>
                            <option value="electrical">Electrical</option>
                            <option value="hvac">HVAC</option>
                            <option value="flooring">Flooring</option>
                            <option value="roofing">Roofing</option>
                            <option value="drywall">Drywall</option>
                            <option value="painting">Painting</option>
                            <option value="tile">Tile Work</option>
                            <option value="carpentry">Carpentry</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hourly Rate</label>
                        <input type="number" step="0.01" class="form-input" name="rate" placeholder="$0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Insurance Status</label>
                        <select class="form-select" name="insurance" required>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending Verification</option>
                            <option value="none">Not Insured</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" class="form-input" name="license" placeholder="License #">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rating (1-5 stars)</label>
                        <select class="form-select" name="rating">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
                            <option value="2">‚≠ê‚≠ê Poor</option>
                            <option value="1">‚≠ê Very Poor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Work quality, reliability, availability notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Subcontractor</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Digital Signature Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Digital Signature</h3>
                <button class="modal-close" onclick="closeModal('signatureModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="signatureName" placeholder="Client name">
                </div>
                <div class="form-group">
                    <label class="form-label">Document Type</label>
                    <select class="form-select" id="signatureDocType">
                        <option value="contract">Contract</option>
                        <option value="estimate">Estimate Approval</option>
                        <option value="completion">Work Completion</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Please sign below:</label>
                    <canvas id="signaturePad" class="signature-pad" width="460" height="200" style="border: 2px dashed #d1d5db; border-radius: 8px; width: 100%; background: white;"></canvas>
                </div>
                <div style="margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                    <button class="btn btn-primary" onclick="saveSignature()">Save Signature</button>
                </div>
            </div>
        </div>
    </div>
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Item</h3>
                <button class="modal-close" onclick="closeModal('itemModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="itemForm" onsubmit="saveItem(event)">
                    <div class="form-group">
                        <label class="form-label">Item Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-input" name="price" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select category</option>
                            <option value="Labor">Labor</option>
                            <option value="Lumber">Lumber</option>
                            <option value="Tile">Tile</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Plumbing">Plumbing</option>
                            <option value="Paint">Paint</option>
                            <option value="Drywall">Drywall</option>
                            <option value="Doors & Windows">Doors & Windows</option>
                            <option value="Roofing">Roofing</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-input" name="notes" placeholder="Optional description">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Item</button>
                </form>
            </div>
        </div>
    </div>

    <div class="offline-indicator" id="offlineIndicator">
        Offline Mode - Data will sync when connection is restored
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // App Data
        let appData = {
            clients: [],
            leads: [],
            projects: [],
            invoices: [],
            estimates: [],
            appointments: [],
            tasks: [],
            expenses: [],
            timeEntries: [],
            documents: [],
            subcontractors: [],
            signatures: [],
            teamMembers: [],
            photos: [],
            activities: [],
            items: []
        };

        // Timer state
        let timerState = {
            isActive: false,
            isPaused: false,
            startTime: null,
            pausedTime: 0,
            currentProject: null,
            interval: null
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadAppData();
                updateDashboard();
                renderAllData();
                registerServiceWorker();
                setupOfflineDetection();
                initializeSignaturePad();
                
                // Load imported data after a delay
                setTimeout(loadRealData, 1000);
            } catch (error) {
                console.error('Initialization error:', error);
                // Fallback initialization
                appData = {
                    clients: [],
                    leads: [],
                    projects: [],
                    invoices: [],
                    estimates: [],
                    appointments: [],
                    tasks: [],
                    expenses: [],
                    timeEntries: [],
                    documents: [],
                    subcontractors: [],
                    signatures: [],
                    teamMembers: [],
                    photos: [],
                    activities: [],
                    items: []
                };
                updateDashboard();
            }
        });

        // Service Worker Registration
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'mjd-crm-v2';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swURL);
            }
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Offline Detection
        function setupOfflineDetection() {
            function updateOnlineStatus() {
                const indicator = document.getElementById('offlineIndicator');
                if (navigator.onLine) {
                    indicator.style.display = 'none';
                } else {
                    indicator.style.display = 'block';
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        // Local Storage Management
        function saveAppData() {
            try {
                localStorage.setItem('mjdCrmData', JSON.stringify(appData));
            } catch (e) {
                console.error('Failed to save data:', e);
            }
        }

        function loadAppData() {
            try {
                const saved = localStorage.getItem('mjdCrmData');
                if (saved) {
                    appData = JSON.parse(saved);
                    // Ensure all arrays exist
                    appData.estimates = appData.estimates || [];
                    appData.appointments = appData.appointments || [];
                    appData.tasks = appData.tasks || [];
                    appData.timeEntries = appData.timeEntries || [];
                    appData.documents = appData.documents || [];
                    appData.subcontractors = appData.subcontractors || [];
                    appData.signatures = appData.signatures || [];
                    appData.estimates = appData.estimates || [];
                    appData.appointments = appData.appointments || [];
                    appData.tasks = appData.tasks || [];
                    appData.expenses = appData.expenses || [];
                }
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        }

        // Navigation
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // Dashboard Updates
        function updateDashboard() {
            document.getElementById('totalClients').textContent = appData.clients.length;
            document.getElementById('activeProjects').textContent = appData.projects.filter(p => p.status !== 'completed').length;
            document.getElementById('monthlyRevenue').textContent = 'input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" name="address" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional client information..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Client</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="leadForm" onsubmit="saveLead(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="projectType" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Value</label>
                        <input type="number" class="form-input" name="estimatedValue" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-select" name="source">
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="social">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Lead details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Lead</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="projectClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="number" class="form-input" name="budget" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Project details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="invoiceClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Invoice notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Invoice</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Estimate Modal -->
    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Estimate</h3>
                <button class="modal-close" onclick="closeModal('estimateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="estimateForm" onsubmit="saveEstimate(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="estimateClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Total</label>
                        <input type="number" step="0.01" class="form-input" name="total" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valid Until</label>
                        <input type="date" class="form-input" name="validUntil" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional estimate details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Estimate</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Appointment</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveAppointment(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="scheduleClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appointment Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select type</option>
                            <option value="consultation">Consultation</option>
                            <option value="estimate">Estimate Visit</option>
                            <option value="work">Work</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" name="time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (hours)</label>
                        <input type="number" step="0.5" class="form-input" name="duration" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Appointment details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Schedule Appointment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" name="title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign to</label>
                        <select class="form-select" name="assignedTo">
                            <option value="">Select team member</option>
                            <option value="self">Myself</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Task details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select category</option>
                            <option value="materials">Materials</option>
                            <option value="tools">Tools</option>
                            <option value="fuel">Fuel</option>
                            <option value="insurance">Insurance</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Office Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Team Member</h3>
                <button class="modal-close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="teamForm" onsubmit="saveTeamMember(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" name="role" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form- + calculateMonthlyRevenue().toLocaleString();
            document.getElementById('pendingInvoices').textContent = appData.invoices.filter(i => i.status === 'pending').length;
            
            updateTodaysSchedule();
            updateExpenseSummary();
        }

        function calculateMonthlyRevenue() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            return appData.invoices
                .filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    return invoiceDate.getMonth() === thisMonth && 
                           invoiceDate.getFullYear() === thisYear &&
                           invoice.status === 'paid';
                })
                .reduce((total, invoice) => total + parseFloat(invoice.amount), 0);
        }

        function updateTodaysSchedule() {
            const today = new Date().toISOString().split('T')[0];
            const todaysAppointments = appData.appointments.filter(apt => apt.date === today);
            
            const container = document.getElementById('todaysSchedule');
            if (todaysAppointments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>No appointments today</h3>
                        <p>Your schedule is clear!</p>
                    </div>
                `;
            } else {
                container.innerHTML = todaysAppointments.map(apt => {
                    const client = appData.clients.find(c => c.id === apt.clientId);
                    return `
                        <div class="appointment-card">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">${client ? client.name : 'Unknown Client'}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">${apt.type} - ${apt.time}</div>
                                </div>
                                <div style="font-size: 12px;">${apt.duration}h</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateExpenseSummary() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyExpenses = appData.expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === thisMonth && expenseDate.getFullYear() === thisYear;
                })
                .reduce((total, expense) => total + parseFloat(expense.amount), 0);

            const yearlyExpenses = appData.expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === thisYear;
                })
                .reduce((total, expense) => total + parseFloat(expense.amount), 0);

            const avgExpense = yearlyExpenses / 12;

            if (document.getElementById('monthlyExpenses')) {
                document.getElementById('monthlyExpenses').textContent = 'input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" name="address" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional client information..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Client</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="leadForm" onsubmit="saveLead(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="projectType" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Value</label>
                        <input type="number" class="form-input" name="estimatedValue" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-select" name="source">
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="social">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Lead details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Lead</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="projectClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="number" class="form-input" name="budget" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Project details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="invoiceClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Invoice notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Invoice</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Estimate Modal -->
    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Estimate</h3>
                <button class="modal-close" onclick="closeModal('estimateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="estimateForm" onsubmit="saveEstimate(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="estimateClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Total</label>
                        <input type="number" step="0.01" class="form-input" name="total" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valid Until</label>
                        <input type="date" class="form-input" name="validUntil" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional estimate details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Estimate</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Appointment</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveAppointment(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="scheduleClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appointment Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select type</option>
                            <option value="consultation">Consultation</option>
                            <option value="estimate">Estimate Visit</option>
                            <option value="work">Work</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" name="time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (hours)</label>
                        <input type="number" step="0.5" class="form-input" name="duration" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Appointment details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Schedule Appointment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" name="title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign to</label>
                        <select class="form-select" name="assignedTo">
                            <option value="">Select team member</option>
                            <option value="self">Myself</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Task details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select category</option>
                            <option value="materials">Materials</option>
                            <option value="tools">Tools</option>
                            <option value="fuel">Fuel</option>
                            <option value="insurance">Insurance</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Office Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Team Member</h3>
                <button class="modal-close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="teamForm" onsubmit="saveTeamMember(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" name="role" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form- + monthlyExpenses.toLocaleString();
                document.getElementById('yearlyExpenses').textContent = 'input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" name="address" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional client information..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Client</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="leadForm" onsubmit="saveLead(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="projectType" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Value</label>
                        <input type="number" class="form-input" name="estimatedValue" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-select" name="source">
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="social">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Lead details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Lead</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="projectClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="number" class="form-input" name="budget" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Project details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="invoiceClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Invoice notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Invoice</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Estimate Modal -->
    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Estimate</h3>
                <button class="modal-close" onclick="closeModal('estimateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="estimateForm" onsubmit="saveEstimate(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="estimateClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Total</label>
                        <input type="number" step="0.01" class="form-input" name="total" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valid Until</label>
                        <input type="date" class="form-input" name="validUntil" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional estimate details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Estimate</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Appointment</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveAppointment(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="scheduleClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appointment Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select type</option>
                            <option value="consultation">Consultation</option>
                            <option value="estimate">Estimate Visit</option>
                            <option value="work">Work</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" name="time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (hours)</label>
                        <input type="number" step="0.5" class="form-input" name="duration" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Appointment details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Schedule Appointment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" name="title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign to</label>
                        <select class="form-select" name="assignedTo">
                            <option value="">Select team member</option>
                            <option value="self">Myself</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Task details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select category</option>
                            <option value="materials">Materials</option>
                            <option value="tools">Tools</option>
                            <option value="fuel">Fuel</option>
                            <option value="insurance">Insurance</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Office Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Team Member</h3>
                <button class="modal-close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="teamForm" onsubmit="saveTeamMember(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" name="role" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form- + yearlyExpenses.toLocaleString();
                document.getElementById('avgExpense').textContent = 'input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" name="address" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional client information..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Client</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="leadForm" onsubmit="saveLead(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="projectType" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Value</label>
                        <input type="number" class="form-input" name="estimatedValue" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-select" name="source">
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="social">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Lead details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Lead</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="projectClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="number" class="form-input" name="budget" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Project details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="invoiceClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Invoice notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Invoice</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Estimate Modal -->
    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Estimate</h3>
                <button class="modal-close" onclick="closeModal('estimateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="estimateForm" onsubmit="saveEstimate(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="estimateClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Total</label>
                        <input type="number" step="0.01" class="form-input" name="total" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valid Until</label>
                        <input type="date" class="form-input" name="validUntil" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional estimate details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Estimate</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Appointment</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveAppointment(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="scheduleClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appointment Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select type</option>
                            <option value="consultation">Consultation</option>
                            <option value="estimate">Estimate Visit</option>
                            <option value="work">Work</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" name="time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (hours)</label>
                        <input type="number" step="0.5" class="form-input" name="duration" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Appointment details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Schedule Appointment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" name="title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign to</label>
                        <select class="form-select" name="assignedTo">
                            <option value="">Select team member</option>
                            <option value="self">Myself</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Task details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select category</option>
                            <option value="materials">Materials</option>
                            <option value="tools">Tools</option>
                            <option value="fuel">Fuel</option>
                            <option value="insurance">Insurance</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Office Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Team Member</h3>
                <button class="modal-close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="teamForm" onsubmit="saveTeamMember(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" name="role" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form- + avgExpense.toLocaleString();
            }
        }

        // Client Management
        function openClientModal() {
            document.getElementById('clientModal').classList.add('active');
        }

        function saveClient(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const client = {
                id: Date.now(),
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                notes: formData.get('notes') || '',
                createdAt: new Date().toISOString(),
                projects: []
            };
            
            appData.clients.push(client);
            addActivity(`New client added: ${client.name}`);
            saveAppData();
            renderClients();
            updateDashboard();
            populateAllClientSelects();
            closeModal('clientModal');
            event.target.reset();
            showNotification('Client added successfully!');
        }

        function renderClients() {
            const container = document.getElementById('clientsList');
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            
            let clients = appData.clients;
            if (searchTerm) {
                clients = clients.filter(client => 
                    client.name.toLowerCase().includes(searchTerm) ||
                    client.email.toLowerCase().includes(searchTerm) ||
                    client.phone.includes(searchTerm)
                );
            }
            
            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>No clients found</h3>
                        <p>Start by adding your first client!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clients.map(client => `
                <div class="client-card slide-in">
                    <div class="client-name">${client.name}</div>
                    <div class="client-info">üìû ${client.phone}</div>
                    <div class="client-info">‚úâÔ∏è ${client.email}</div>
                    <div class="client-info">üìç ${client.address}</div>
                    ${client.notes ? `<div class="client-info">üìù ${client.notes}</div>` : ''}
                    <div class="btn-group">
                        <button class="btn btn-small btn-secondary" onclick="viewClientProjects(${client.id})">Projects</button>
                        <button class="btn btn-small btn-primary" onclick="createInvoiceForClient(${client.id})">Invoice</button>
                        <button class="btn btn-small btn-success" onclick="callClient('${client.phone}')">Call</button>
                    </div>
                </div>
            `).join('');
        }

        function searchClients() {
            renderClients();
        }

        function callClient(phone) {
            window.location.href = `tel:${phone}`;
        }

        // Lead Management
        function openLeadModal() {
            document.getElementById('leadModal').classList.add('active');
        }

        function saveLead(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const lead = {
                id: Date.now(),
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                projectType: formData.get('projectType'),
                estimatedValue: parseFloat(formData.get('estimatedValue')) || 0,
                source: formData.get('source'),
                notes: formData.get('notes') || '',
                createdAt: new Date().toISOString(),
                status: 'new',
                score: calculateLeadScore({
                    estimatedValue: parseFloat(formData.get('estimatedValue')) || 0,
                    source: formData.get('source'),
                    projectType: formData.get('projectType'),
                    createdAt: new Date().toISOString()
                })
            };
            
            appData.leads.push(lead);
            addActivity(`New lead added: ${lead.name} (Score: ${lead.score})`);
            saveAppData();
            renderLeads();
            updateDashboard();
            closeModal('leadModal');
            event.target.reset();
            showNotification('Lead added successfully!');
        }

        function calculateLeadScore(lead) {
            let score = 0;
            
            // Project value (0-40 points)
            if (lead.estimatedValue >= 20000) score += 40;
            else if (lead.estimatedValue >= 10000) score += 30;
            else if (lead.estimatedValue >= 5000) score += 20;
            else score += 10;
            
            // Source quality (0-20 points)
            const sourceScores = {
                referral: 20,
                website: 15,
                social: 10,
                advertisement: 8,
                other: 5
            };
            score += sourceScores[lead.source] || 5;
            
            // Recency (0-20 points)
            const daysOld = (Date.now() - new Date(lead.createdAt)) / (1000 * 60 * 60 * 24);
            if (daysOld < 1) score += 20;
            else if (daysOld < 3) score += 15;
            else if (daysOld < 7) score += 10;
            else score += 5;
            
            // Project type (0-20 points)
            const projectScores = {
                kitchen: 20,
                bathroom: 18,
                roofing: 15,
                siding: 12,
                deck: 10
            };
            score += projectScores[lead.projectType] || 10;
            
            return Math.min(100, score);
        }

        function renderLeads() {
            const container = document.getElementById('leadsList');
            const activeFilter = document.querySelector('.filter-chips .filter-chip.active[data-status]')?.dataset.status || 'all';
            
            let leads = appData.leads;
            if (activeFilter !== 'all') {
                leads = leads.filter(lead => lead.status === activeFilter);
            }
            
            if (leads.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <h3>No leads found</h3>
                        <p>Add your first lead to start growing your business!</p>
                    </div>
                `;
                return;
            }
            
            const sortedLeads = leads.sort((a, b) => b.score - a.score);
            
            container.innerHTML = sortedLeads.map(lead => {
                const scoreClass = lead.score >= 70 ? 'lead-score-high' : 
                                 lead.score >= 40 ? 'lead-score-medium' : 'lead-score-low';
                
                return `
                    <div class="client-card slide-in">
                        <div class="client-name">
                            ${lead.name}
                            <span class="lead-score ${scoreClass}">${lead.score}</span>
                        </div>
                        <div class="client-info">üìû ${lead.phone}</div>
                        <div class="client-info">üèóÔ∏è ${lead.projectType}</div>
                        <div class="client-info">üí∞ ${lead.estimatedValue.toLocaleString()}</div>
                        <div class="client-info">üìä ${lead.source}</div>
                        <div class="client-info">
                            <span class="status-badge status-${lead.status}">${lead.status}</span>
                        </div>
                        ${lead.notes ? `<div class="client-info">üìù ${lead.notes}</div>` : ''}
                        <div class="btn-group">
                            <button class="btn btn-small btn-success" onclick="convertLead(${lead.id})">Convert</button>
                            <button class="btn btn-small btn-secondary" onclick="updateLeadStatus(${lead.id})">Update</button>
                            <button class="btn btn-small btn-primary" onclick="contactLead(${lead.id})">Contact</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLeads(status) {
            document.querySelectorAll('.filter-chips .filter-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            renderLeads();
        }

        function updateLeadStatus(leadId) {
            const lead = appData.leads.find(l => l.id === leadId);
            if (lead) {
                const statuses = ['new', 'contacted', 'qualified', 'proposal_sent'];
                const currentIndex = statuses.indexOf(lead.status);
                const nextStatus = statuses[Math.min(currentIndex + 1, statuses.length - 1)];
                
                lead.status = nextStatus;
                addActivity(`Lead status updated: ${lead.name} - ${nextStatus}`);
                saveAppData();
                renderLeads();
                showNotification(`Lead status updated to ${nextStatus}`);
            }
        }

        function convertLead(leadId) {
            const lead = appData.leads.find(l => l.id === leadId);
            if (lead) {
                const client = {
                    id: Date.now(),
                    name: lead.name,
                    phone: lead.phone,
                    email: lead.email,
                    address: '',
                    notes: lead.notes,
                    createdAt: new Date().toISOString(),
                    projects: []
                };
                
                appData.clients.push(client);
                appData.leads = appData.leads.filter(l => l.id !== leadId);
                addActivity(`Lead converted to client: ${lead.name}`);
                saveAppData();
                renderLeads();
                renderClients();
                updateDashboard();
                populateAllClientSelects();
                showNotification(`${lead.name} converted to client!`);
            }
        }

        function contactLead(leadId) {
            const lead = appData.leads.find(l => l.id === leadId);
            if (lead) {
                const action = confirm(`Contact ${lead.name}?\n\nPhone: ${lead.phone}\nEmail: ${lead.email}\n\nClick OK to call, Cancel to send SMS`);
                if (action) {
                    window.location.href = `tel:${lead.phone}`;
                } else {
                    window.location.href = `sms:${lead.phone}?body=Hi ${lead.name}, this is MJD Home Improvement regarding your ${lead.projectType} project. When would be a good time to discuss your project?`;
                }
            }
        }

        // Project Management
        function openProjectModal() {
            populateAllClientSelects();
            document.getElementById('projectModal').classList.add('active');
        }

        function populateAllClientSelects() {
            const selects = ['projectClientSelect', 'invoiceClientSelect', 'estimateClientSelect', 'scheduleClientSelect', 'timeProjectSelect', 'documentClientSelect', 'documentProjectSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    if (selectId === 'timeProjectSelect' || selectId === 'documentProjectSelect') {
                        // Populate with projects
                        select.innerHTML = '<option value="">Select project</option>' + 
                            appData.projects.map(project => 
                                `<option value="${project.id}">${project.name}</option>`
                            ).join('');
                    } else {
                        // Populate with clients
                        select.innerHTML = '<option value="">Select client</option>' + 
                            appData.clients.map(client => 
                                `<option value="${client.id}">${client.name}</option>`
                            ).join('');
                    }
                }
            });
        }

        function saveProject(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const project = {
                id: Date.now(),
                clientId: parseInt(formData.get('clientId')),
                name: formData.get('name'),
                type: formData.get('type'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                budget: parseFloat(formData.get('budget')) || 0,
                description: formData.get('description') || '',
                progress: 0,
                status: 'planning',
                createdAt: new Date().toISOString()
            };
            
            appData.projects.push(project);
            addActivity(`New project created: ${project.name}`);
            saveAppData();
            renderProjects();
            updateDashboard();
            closeModal('projectModal');
            event.target.reset();
            showNotification('Project created successfully!');
        }

        function renderProjects() {
            const container = document.getElementById('projectsList');
            const activeFilter = document.querySelector('#projects .filter-chips .filter-chip.active[data-status]')?.dataset.status || 'all';
            
            let projects = appData.projects;
            if (activeFilter !== 'all') {
                projects = projects.filter(project => project.status === activeFilter);
            }
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèóÔ∏è</div>
                        <h3>No projects found</h3>
                        <p>Create your first project!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(project => {
                const client = appData.clients.find(c => c.id === project.clientId);
                const statusColors = {
                    planning: '#f59e0b',
                    in_progress: '#3b82f6',
                    completed: '#10b981',
                    on_hold: '#ef4444'
                };
                
                return `
                    <div class="client-card slide-in">
                        <div class="client-name">${project.name}</div>
                        <div class="client-info">üë§ ${client ? client.name : 'Unknown Client'}</div>
                        <div class="client-info">üèóÔ∏è ${project.type}</div>
                        <div class="client-info">üí∞ ${project.budget.toLocaleString()}</div>
                        <div class="client-info">üìÖ ${project.startDate} to ${project.endDate}</div>
                        ${project.description ? `<div class="client-info">üìù ${project.description}</div>` : ''}
                        <div style="margin-top: 8px;">
                            <span style="color: ${statusColors[project.status]}">‚óè ${project.status.replace('_', ' ')}</span>
                            <div class="progress-bar" style="margin-top: 8px;">
                                <div class="progress-fill" style="width: ${project.progress}%"></div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-small btn-secondary" onclick="updateProjectProgress(${project.id})">Progress</button>
                                <button class="btn btn-small btn-primary" onclick="createInvoiceForProject(${project.id})">Invoice</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterProjects(status) {
            document.querySelectorAll('#projects .filter-chips .filter-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector(`#projects [data-status="${status}"]`).classList.add('active');
            renderProjects();
        }

        function updateProjectProgress(projectId) {
            const project = appData.projects.find(p => p.id === projectId);
            if (project) {
                const newProgress = prompt(`Current progress: ${project.progress}%\nEnter new progress (0-100):`);
                if (newProgress !== null && !isNaN(newProgress)) {
                    project.progress = Math.max(0, Math.min(100, parseInt(newProgress)));
                    if (project.progress === 100) {
                        project.status = 'completed';
                        addActivity(`Project completed: ${project.name}`);
                    } else if (project.progress > 0 && project.status === 'planning') {
                        project.status = 'in_progress';
                    }
                    saveAppData();
                    renderProjects();
                    updateDashboard();
                    showNotification('Project progress updated!');
                }
            }
        }

        function createInvoiceForProject(projectId) {
            populateAllClientSelects();
            const project = appData.projects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('invoiceModal').classList.add('active');
                // Pre-fill some fields
                setTimeout(() => {
                    const clientSelect = document.getElementById('invoiceClientSelect');
                    const descriptionField = document.querySelector('#invoiceForm [name="description"]');
                    const amountField = document.querySelector('#invoiceForm [name="amount"]');
                    
                    if (clientSelect) clientSelect.value = project.clientId;
                    if (descriptionField) descriptionField.value = `Work on ${project.name}`;
                    if (amountField && project.budget) amountField.value = project.budget;
                }, 100);
            }
        }

        // Invoice Management
        function openInvoiceModal() {
            populateAllClientSelects();
            document.getElementById('invoiceModal').classList.add('active');
        }

        function saveInvoice(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const invoice = {
                id: Date.now(),
                clientId: parseInt(formData.get('clientId')),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                dueDate: formData.get('dueDate'),
                notes: formData.get('notes') || '',
                status: 'pending',
                date: new Date().toISOString(),
                paymentLinks: generatePaymentLinks(parseFloat(formData.get('amount')))
            };
            
            appData.invoices.push(invoice);
            addActivity(`New invoice created: ${invoice.amount} for ${appData.clients.find(c => c.id === invoice.clientId)?.name || 'Unknown Client'}`);
            saveAppData();
            renderInvoices();
            updateDashboard();
            closeModal('invoiceModal');
            event.target.reset();
            showNotification('Invoice created successfully!');
        }

        function generatePaymentLinks(amount) {
            return {
                venmo: `https://venmo.com/code?user_id=MJDHomeImprovement&amount=${amount}&note=Invoice Payment`,
                paypal: `https://paypal.me/mjdhomeimprovement/${amount}`,
                cashapp: `https://cash.app/$mjdhomeimprovement/${amount}`,
                stripe: `#stripe-payment-${amount}`
            };
        }

        function renderInvoices() {
            const container = document.getElementById('invoicesList');
            const activeFilter = document.querySelector('#invoices .filter-chips .filter-chip.active[data-status]')?.dataset.status || 'all';
            
            let invoices = appData.invoices;
            
            // Apply status filter
            if (activeFilter !== 'all') {
                if (activeFilter === 'overdue') {
                    invoices = invoices.filter(invoice => {
                        const isOverdue = new Date(invoice.dueDate) < new Date() && invoice.status === 'pending';
                        return isOverdue;
                    });
                } else {
                    invoices = invoices.filter(invoice => invoice.status === activeFilter);
                }
            }
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí≥</div>
                        <h3>No invoices found</h3>
                        <p>Create your first invoice!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = invoices.map(invoice => {
                const client = appData.clients.find(c => c.id === invoice.clientId);
                const statusColors = {
                    pending: '#f59e0b',
                    paid: '#10b981',
                    overdue: '#ef4444',
                    partial: '#3b82f6'
                };
                
                const isOverdue = new Date(invoice.dueDate) < new Date() && invoice.status === 'pending';
                const currentStatus = isOverdue ? 'overdue' : invoice.status;
                
                return `
                    <div class="client-card slide-in">
                        <div class="client-name">
                            Invoice #${invoice.id.toString().slice(-6)}
                            <span style="color: ${statusColors[currentStatus]}; font-size: 12px;">‚óè ${currentStatus}</span>
                        </div>
                        <div class="client-info">üë§ ${client ? client.name : 'Unknown Client'}</div>
                        <div class="client-info">üìù ${invoice.description}</div>
                        <div class="client-info">üí∞ ${invoice.amount.toLocaleString()}</div>
                        <div class="client-info">üìÖ Due: ${new Date(invoice.dueDate).toLocaleDateString()}</div>
                        ${invoice.notes ? `<div class="client-info">üìù ${invoice.notes}</div>` : ''}
                        ${invoice.status === 'pending' ? `
                            <div style="margin-top: 12px;">
                                <a href="${invoice.paymentLinks.venmo}" style="display: block; padding: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-decoration: none; border-radius: 6px; text-align: center; font-weight: 500; margin: 4px 0;" target="_blank">Pay with Venmo</a>
                                <a href="${invoice.paymentLinks.paypal}" style="display: block; padding: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-decoration: none; border-radius: 6px; text-align: center; font-weight: 500; margin: 4px 0;" target="_blank">Pay with PayPal</a>
                            </div>
                        ` : ''}
                        <div class="btn-group">
                            <button class="btn btn-small btn-secondary" onclick="viewInvoiceDetails(${invoice.id})">Details</button>
                            ${invoice.status === 'pending' ? `<button class="btn btn-small btn-success" onclick="markInvoicePaid(${invoice.id})">Mark Paid</button>` : ''}
                            <button class="btn btn-small btn-primary" onclick="sendInvoice(${invoice.id})">Send</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterInvoices(status) {
            document.querySelectorAll('#invoices .filter-chips .filter-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector(`#invoices [data-status="${status}"]`).classList.add('active');
            renderInvoices();
        }

        function viewInvoiceDetails(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (invoice) {
                const client = appData.clients.find(c => c.id === invoice.clientId);
                alert(`Invoice #${invoice.id.toString().slice(-6)}\nClient: ${client?.name || 'Unknown'}\nAmount: ${invoice.amount}\nDue: ${new Date(invoice.dueDate).toLocaleDateString()}\nStatus: ${invoice.status}\n\nDescription: ${invoice.description}`);
            }
        }

        function markInvoicePaid(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (invoice) {
                invoice.status = 'paid';
                invoice.paidDate = new Date().toISOString();
                addActivity(`Invoice paid: ${invoice.amount}`);
                saveAppData();
                renderInvoices();
                updateDashboard();
                showNotification('Invoice marked as paid!');
            }
        }

        function sendInvoice(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (invoice) {
                const client = appData.clients.find(c => c.id === invoice.clientId);
                if (client) {
                    const subject = `Invoice from MJD Home Improvement - ${invoice.amount}`;
                    const body = `Dear ${client.name},\n\nPlease find your invoice details below:\n\nDescription: ${invoice.description}\nAmount: ${invoice.amount}\nDue Date: ${new Date(invoice.dueDate).toLocaleDateString()}\n\nPayment Links:\nVenmo: ${invoice.paymentLinks.venmo}\nPayPal: ${invoice.paymentLinks.paypal}\n\nThank you!\nMJD Home Improvement\n(508)-902-7529`;
                    
                    window.location.href = `mailto:${client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }
            }
        }

        // Estimate Management
        function openEstimateModal() {
            populateAllClientSelects();
            document.getElementById('estimateModal').classList.add('active');
        }

        function saveEstimate(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const estimate = {
                id: Date.now(),
                clientId: parseInt(formData.get('clientId')),
                description: formData.get('description'),
                total: parseFloat(formData.get('total')),
                validUntil: formData.get('validUntil'),
                notes: formData.get('notes') || '',
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            appData.estimates.push(estimate);
            addActivity(`New estimate created: ${estimate.total} for ${appData.clients.find(c => c.id === estimate.clientId)?.name || 'Unknown Client'}`);
            saveAppData();
            renderEstimates();
            closeModal('estimateModal');
            event.target.reset();
            showNotification('Estimate created successfully!');
        }

        function renderEstimates() {
            const container = document.getElementById('estimatesList');
            
            if (appData.estimates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No estimates yet</h3>
                        <p>Create your first estimate!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.estimates.map(estimate => {
                const client = appData.clients.find(c => c.id === estimate.clientId);
                const isExpired = new Date(estimate.validUntil) < new Date();
                
                return `
                    <div class="client-card slide-in">
                        <div class="client-name">
                            Estimate #${estimate.id.toString().slice(-6)}
                            <span class="status-badge ${isExpired ? 'status-overdue' : 'status-' + estimate.status}">${isExpired ? 'expired' : estimate.status}</span>
                        </div>
                        <div class="client-info">üë§ ${client ? client.name : 'Unknown Client'}</div>
                        <div class="client-info">üìù ${estimate.description}</div>
                        <div class="client-info">üí∞ ${estimate.total.toLocaleString()}</div>
                        <div class="client-info">üìÖ Valid until: ${new Date(estimate.validUntil).toLocaleDateString()}</div>
                        ${estimate.notes ? `<div class="client-info">üìù ${estimate.notes}</div>` : ''}
                        <div class="btn-group">
                            <button class="btn btn-small btn-secondary" onclick="viewEstimate(${estimate.id})">View</button>
                            <button class="btn btn-small btn-primary" onclick="sendEstimate(${estimate.id})">Send</button>
                            ${estimate.status === 'pending' ? `<button class="btn btn-small btn-success" onclick="acceptEstimate(${estimate.id})">Accept</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewEstimate(estimateId) {
            const estimate = appData.estimates.find(e => e.id === estimateId);
            if (estimate) {
                const client = appData.clients.find(c => c.id === estimate.clientId);
                alert(`Estimate #${estimate.id.toString().slice(-6)}\nClient: ${client?.name || 'Unknown'}\nProject: ${estimate.description}\nTotal: ${estimate.total}\nValid until: ${new Date(estimate.validUntil).toLocaleDateString()}\nStatus: ${estimate.status}`);
            }
        }

        function sendEstimate(estimateId) {
            const estimate = appData.estimates.find(e => e.id === estimateId);
            if (estimate) {
                const client = appData.clients.find(c => c.id === estimate.clientId);
                if (client) {
                    const subject = `Estimate from MJD Home Improvement - ${estimate.total}`;
                    const body = `Dear ${client.name},\n\nPlease find your project estimate below:\n\nProject: ${estimate.description}\nEstimated Total: ${estimate.total}\nValid Until: ${new Date(estimate.validUntil).toLocaleDateString()}\n\n${estimate.notes}\n\nPlease let us know if you have any questions!\n\nBest regards,\nMJD Home Improvement\n(508)-902-7529`;
                    
                    window.location.href = `mailto:${client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }
            }
        }

        function acceptEstimate(estimateId) {
            const estimate = appData.estimates.find(e => e.id === estimateId);
            if (estimate) {
                estimate.status = 'accepted';
                addActivity(`Estimate accepted: ${estimate.description} - ${estimate.total}`);
                saveAppData();
                renderEstimates();
                showNotification('Estimate marked as accepted!');
            }
        }

        // Scheduling Management
        function openScheduleModal() {
            populateAllClientSelects();
            document.getElementById('scheduleModal').classList.add('active');
        }

        function saveAppointment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const appointment = {
                id: Date.now(),
                clientId: parseInt(formData.get('clientId')),
                type: formData.get('type'),
                date: formData.get('date'),
                time: formData.get('time'),
                duration: parseFloat(formData.get('duration')),
                notes: formData.get('notes') || '',
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            appData.appointments.push(appointment);
            addActivity(`Appointment scheduled: ${appointment.type} with ${appData.clients.find(c => c.id === appointment.clientId)?.name || 'Unknown Client'}`);
            saveAppData();
            renderAppointments();
            updateTodaysSchedule();
            closeModal('scheduleModal');
            event.target.reset();
            showNotification('Appointment scheduled successfully!');
        }

        function renderAppointments() {
            const container = document.getElementById('appointmentsList');
            
            if (appData.appointments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>No appointments scheduled</h3>
                        <p>Schedule your first appointment!</p>
                    </div>
                `;
                return;
            }
            
            const sortedAppointments = appData.appointments.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
            
            container.innerHTML = sortedAppointments.map(appointment => {
                const client = appData.clients.find(c => c.id === appointment.clientId);
                const appointmentDate = new Date(appointment.date + ' ' + appointment.time);
                const isPast = appointmentDate < new Date();
                
                return `
                    <div class="appointment-card slide-in">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">${client ? client.name : 'Unknown Client'}</div>
                                <div style="opacity: 0.9; margin: 4px 0;">${appointment.type}</div>
                                <div style="font-size: 14px; opacity: 0.8;">
                                    ${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}
                                </div>
                                <div style="font-size: 12px; opacity: 0.7;">${appointment.duration} hour(s)</div>
                                ${appointment.notes ? `<div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">${appointment.notes}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 12px; margin-bottom: 8px;">
                                    ${isPast ? 'Past' : 'Upcoming'}
                                </div>
                                ${!isPast ? `
                                    <button class="btn btn-small btn-secondary" onclick="completeAppointment(${appointment.id})" style="padding: 4px 8px; font-size: 11px;">Complete</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function completeAppointment(appointmentId) {
            const appointment = appData.appointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = 'completed';
                addActivity(`Appointment completed: ${appointment.type}`);
                saveAppData();
                renderAppointments();
                updateTodaysSchedule();
                showNotification('Appointment marked as completed!');
            }
        }

        // Task Management
        function openTaskModal() {
            document.getElementById('taskModal').classList.add('active');
        }

        function saveTask(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const task = {
                id: Date.now(),
                title: formData.get('title'),
                priority: formData.get('priority'),
                dueDate: formData.get('dueDate'),
                assignedTo: formData.get('assignedTo') || 'self',
                description: formData.get('description') || '',
                status: 'pending',
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            appData.tasks.push(task);
            addActivity(`New task created: ${task.title}`);
            saveAppData();
            renderTasks();
            closeModal('taskModal');
            event.target.reset();
            showNotification('Task added successfully!');
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            
            if (appData.tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>No tasks yet</h3>
                        <p>Add your first task to get organized!</p>
                    </div>
                `;
                return;
            }
            
            const sortedTasks = appData.tasks.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed - b.completed;
                const priorities = { high: 3, medium: 2, low: 1 };
                return priorities[b.priority] - priorities[a.priority];
            });
            
            container.innerHTML = sortedTasks.map(task => {
                return `
                    <div class="task-item slide-in" style="opacity: ${task.completed ? '0.6' : '1'}">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="toggleTask(${task.id})">
                        <div class="task-content">
                            <div style="font-weight: 600; ${task.completed ? 'text-decoration: line-through;' : ''}">${task.title}</div>
                            ${task.description ? `<div style="font-size: 14px; color: #64748b; margin-top: 2px;">${task.description}</div>` : ''}
                            ${task.dueDate ? `<div style="font-size: 12px; color: #64748b; margin-top: 4px;">Due: ${new Date(task.dueDate).toLocaleDateString()}</div>` : ''}
                        </div>
                        <div class="task-priority priority-${task.priority}"></div>
                    </div>
                `;
            }).join('');
        }

        function toggleTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                task.status = task.completed ? 'completed' : 'pending';
                addActivity(`Task ${task.completed ? 'completed' : 'reopened'}: ${task.title}`);
                saveAppData();
                renderTasks();
                showNotification(`Task ${task.completed ? 'completed' : 'reopened'}!`);
            }
        }

        // Expense Management
        function openExpenseModal() {
            // Set today's date as default
            setTimeout(() => {
                const dateInput = document.querySelector('#expenseForm [name="date"]');
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }, 100);
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const expense = {
                id: Date.now(),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                category: formData.get('category'),
                date: formData.get('date'),
                notes: formData.get('notes') || '',
                createdAt: new Date().toISOString()
            };
            
            appData.expenses.push(expense);
            addActivity(`New expense added: ${expense.description} - ${expense.amount}`);
            saveAppData();
            renderExpenses();
            updateExpenseSummary();
            closeModal('expenseModal');
            event.target.reset();
            showNotification('Expense added successfully!');
        }

        function renderExpenses() {
            const container = document.getElementById('expensesList');
            
            if (appData.expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <h3>No expenses yet</h3>
                        <p>Track your first business expense!</p>
                    </div>
                `;
                return;
            }
            
            const sortedExpenses = appData.expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedExpenses.map(expense => {
                return `
                    <div class="client-card slide-in">
                        <div class="client-name">${expense.description}</div>
                        <div class="client-info">üí∞ ${expense.amount.toFixed(2)}</div>
                        <div class="client-info">üìÇ ${expense.category}</div>
                        <div class="client-info">üìÖ ${new Date(expense.date).toLocaleDateString()}</div>
                        ${expense.notes ? `<div class="client-info">üìù ${expense.notes}</div>` : ''}
                        <div class="btn-group">
                            <button class="btn btn-small btn-secondary" onclick="editExpense(${expense.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteExpense(${expense.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editExpense(expenseId) {
            const expense = appData.expenses.find(e => e.id === expenseId);
            if (expense) {
                const newAmount = prompt(`Edit amount for ${expense.description}:\nCurrent: ${expense.amount}`, expense.amount);
                if (newAmount !== null && !isNaN(newAmount)) {
                    expense.amount = parseFloat(newAmount);
                    addActivity(`Expense updated: ${expense.description} - ${expense.amount}`);
                    saveAppData();
                    renderExpenses();
                    updateExpenseSummary();
                    showNotification('Expense updated!');
                }
            }
        }

        function deleteExpense(expenseId) {
            const expense = appData.expenses.find(e => e.id === expenseId);
            if (expense && confirm(`Delete expense: ${expense.description}?`)) {
                appData.expenses = appData.expenses.filter(e => e.id !== expenseId);
                addActivity(`Expense deleted: ${expense.description}`);
                saveAppData();
                renderExpenses();
                updateExpenseSummary();
                showNotification('Expense deleted!');
            }
        }

        // Calculator Functions (keeping existing functionality)
        function updateCalculator() {
            const projectType = document.getElementById('projectType').value;
            const materialGrade = document.getElementById('materialGrade').value;
            const sqft = parseFloat(document.getElementById('squareFootage').value) || 0;
            
            if (sqft === 0) {
                document.getElementById('costBreakdown').innerHTML = '<p style="color: #64748b;">Enter square footage to see cost breakdown</p>';
                return;
            }
            
            const pricing = {
                deck: {
                    standard: { material: 15, labor: 25 },
                    premium: { material: 25, labor: 35 },
                    luxury: { material: 45, labor: 50 }
                },
                kitchen: {
                    standard: { material: 80, labor: 60 },
                    premium: { material: 120, labor: 80 },
                    luxury: { material: 200, labor: 120 }
                },
                bathroom: {
                    standard: { material: 60, labor: 50 },
                    premium: { material: 90, labor: 70 },
                    luxury: { material: 150, labor: 100 }
                },
                siding: {
                    standard: { material: 8, labor: 12 },
                    premium: { material: 15, labor: 18 },
                    luxury: { material: 25, labor: 25 }
                },
                roofing: {
                    standard: { material: 4, labor: 8 },
                    premium: { material: 8, labor: 12 },
                    luxury: { material: 15, labor: 20 }
                }
            };
            
            const rates = pricing[projectType][materialGrade];
            const materialCost = sqft * rates.material;
            const laborCost = sqft * rates.labor;
            const subtotal = materialCost + laborCost;
            const tax = subtotal * 0.0625; // MA tax rate
            const total = subtotal + tax;
            
            document.getElementById('costBreakdown').innerHTML = `
                <h4>Cost Breakdown</h4>
                <div class="cost-item">
                    <span>Materials (${sqft} sq ft √ó ${rates.material})</span>
                    <strong>${materialCost.toLocaleString()}</strong>
                </div>
                <div class="cost-item">
                    <span>Labor (${sqft} sq ft √ó ${rates.labor})</span>
                    <strong>${laborCost.toLocaleString()}</strong>
                </div>
                <div class="cost-item">
                    <span>Subtotal</span>
                    <strong>${subtotal.toLocaleString()}</strong>
                </div>
                <div class="cost-item">
                    <span>Tax (6.25%)</span>
                    <strong>${tax.toLocaleString()}</strong>
                </div>
                <div class="cost-item cost-total">
                    <span>Total</span>
                    <strong>${total.toLocaleString()}</strong>
                </div>
                <div class="btn-group" style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="createEstimateFromCalculation(${total})">Create Estimate</button>
                    <button class="btn btn-secondary" onclick="saveCalculation()">Save Calculation</button>
                </div>
            `;
        }

        function createEstimateFromCalculation(total) {
            if (appData.clients.length === 0) {
                alert('Please add a client first before creating an estimate.');
                return;
            }
            
            populateAllClientSelects();
            document.getElementById('estimateModal').classList.add('active');
            
            setTimeout(() => {
                const totalField = document.querySelector('#estimateForm [name="total"]');
                const descriptionField = document.querySelector('#estimateForm [name="description"]');
                const projectType = document.getElementById('projectType').value;
                const sqft = document.getElementById('squareFootage').value;
                
                if (totalField) totalField.value = total.toFixed(2);
                if (descriptionField) descriptionField.value = `${projectType} project - ${sqft} sq ft`;
            }, 100);
        }

        function saveCalculation() {
            const projectType = document.getElementById('projectType').value;
            const materialGrade = document.getElementById('materialGrade').value;
            const sqft = document.getElementById('squareFootage').value;
            
            addActivity(`Calculation saved: ${projectType} ${materialGrade} - ${sqft} sq ft`);
            showNotification('Calculation saved to activity log!');
        }

        // Team Management (keeping existing functionality)
        function openTeamModal() {
            document.getElementById('teamModal').classList.add('active');
        }

        function saveTeamMember(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const member = {
                id: Date.now(),
                name: formData.get('name'),
                role: formData.get('role'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                rate: parseFloat(formData.get('rate')) || 0,
                skills: formData.get('skills'),
                status: 'available',
                joinDate: new Date().toISOString()
            };
            
            appData.teamMembers.push(member);
            addActivity(`New team member added: ${member.name}`);
            saveAppData();
            renderTeamMembers();
            closeModal('teamModal');
            event.target.reset();
            showNotification('Team member added successfully!');
        }

        function renderTeamMembers() {
            const container = document.getElementById('teamList');
            if (appData.teamMembers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>No team members yet</h3>
                        <p>Add your first team member!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.teamMembers.map(member => `
                <div style="display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;" class="slide-in">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 12px;">
                        ${member.name.charAt(0)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1e293b;">${member.name}</div>
                        <div style="font-size: 12px; color: #64748b;">${member.role} ‚Ä¢ ${member.rate || 0}/hr</div>
                        <div style="font-size: 12px; color: #64748b;">${member.skills || 'N/A'}</div>
                        ${member.phone ? `<div style="font-size: 12px; color: #64748b;">üìû ${member.phone}</div>` : ''}
                    </div>
                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #dcfce7; color: #166534;">
                        ${member.status || 'available'}
                    </span>
                </div>
            `).join('');
        }

        // Photo Management (keeping existing functionality)
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photo = {
                            id: Date.now() + Math.random(),
                            url: e.target.result,
                            name: file.name,
                            uploadDate: new Date().toISOString(),
                            size: file.size,
                            type: file.type
                        };
                        appData.photos.push(photo);
                        saveAppData();
                        renderPhotos();
                        addActivity(`Photo uploaded: ${photo.name}`);
                        showNotification('Photo uploaded successfully!');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderPhotos() {
            const container = document.getElementById('photoGrid');
            if (appData.photos.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 120px; color: #64748b; font-size: 12px; text-align: center; background: #f1f5f9; border-radius: 8px;">No photos uploaded yet</div>';
                return;
            }
            
            container.innerHTML = appData.photos.map(photo => `
                <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: #f1f5f9; cursor: pointer;" onclick="viewPhotoDetails(${photo.id})" class="slide-in">
                    <img src="${photo.url}" alt="${photo.name}" loading="lazy" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 2px 4px; border-radius: 4px;">
                        ${photo.name.length > 15 ? photo.name.substring(0, 12) + '...' : photo.name}
                    </div>
                </div>
            `).join('');
        }

        function viewPhotoDetails(photoId) {
            const photo = appData.photos.find(p => p.id === photoId);
            if (photo) {
                alert(`Photo: ${photo.name}\nUploaded: ${new Date(photo.uploadDate).toLocaleDateString()}\nSize: ${(photo.size / 1024).toFixed(1)} KB`);
            }
        }

        // Inventory Management
        function renderInventory() {
            const container = document.getElementById('inventoryList');
            if (!appData.items || appData.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No inventory items yet</h3>
                        <p>Add your first inventory item!</p>
                    </div>
                `;
                return;
            }
            
            let items = appData.items;
            const search = document.getElementById('inventorySearch')?.value?.toLowerCase() || '';
            const category = document.getElementById('categoryFilter')?.value || '';
            
            // Apply filters
            if (search) {
                items = items.filter(item => 
                    item.name.toLowerCase().includes(search) || 
                    (item.notes && item.notes.toLowerCase().includes(search))
                );
            }
            if (category) {
                items = items.filter(item => item.category === category);
            }
            
            container.innerHTML = items.map(item => `
                <div class="client-card slide-in">
                    <div class="client-name">${item.name}</div>
                    <div class="client-info">üí∞ ${item.price.toFixed(2)}</div>
                    <div class="client-info">üìÇ ${item.category}</div>
                    ${item.notes ? `<div class="client-info">üìù ${item.notes}</div>` : ''}
                    <div class="btn-group">
                        <button class="btn btn-small btn-secondary" onclick="editItem(${item.id})">Edit</button>
                        <button class="btn btn-small btn-primary" onclick="addItemToEstimate(${item.id})">Add to Estimate</button>
                        <button class="btn btn-small btn-danger" onclick="deleteItem(${item.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function searchInventory() {
            renderInventory();
        }

        function filterInventory() {
            renderInventory();
        }

        function openItemModal() {
            document.getElementById('itemModal').classList.add('active');
        }

        function saveItem(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const item = {
                id: Date.now(),
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                category: formData.get('category'),
                notes: formData.get('notes') || '',
                createdAt: new Date().toISOString()
            };
            
            if (!appData.items) appData.items = [];
            appData.items.push(item);
            addActivity(`New item added: ${item.name} - ${item.price}`);
            saveAppData();
            renderInventory();
            closeModal('itemModal');
            event.target.reset();
            showNotification('Item added successfully!');
        }

        function editItem(itemId) {
            const item = appData.items.find(i => i.id === itemId);
            if (item) {
                const newPrice = prompt(`Edit price for ${item.name}:\nCurrent: ${item.price}`, item.price);
                if (newPrice !== null && !isNaN(newPrice)) {
                    item.price = parseFloat(newPrice);
                    saveAppData();
                    renderInventory();
                    addActivity(`Updated item price: ${item.name} - ${item.price}`);
                    showNotification('Item price updated!');
                }
            }
        }

        function deleteItem(itemId) {
            const item = appData.items.find(i => i.id === itemId);
            if (item && confirm(`Delete ${item.name}?`)) {
                appData.items = appData.items.filter(i => i.id !== itemId);
                addActivity(`Item deleted: ${item.name}`);
                saveAppData();
                renderInventory();
                showNotification('Item deleted!');
            }
        }

        function addItemToEstimate(itemId) {
            const item = appData.items.find(i => i.id === itemId);
            if (item) {
                alert(`Added ${item.name} (${item.price}) to estimate.\n\nFull estimate builder coming in next update!`);
                addActivity(`Added ${item.name} to estimate`);
            }
        }

        // Reports Management
        function generateReport() {
            const report = {
                generatedAt: new Date().toISOString(),
                totalClients: appData.clients.length,
                totalLeads: appData.leads.length,
                activeProjects: appData.projects.filter(p => p.status !== 'completed').length,
                completedProjects: appData.projects.filter(p => p.status === 'completed').length,
                monthlyRevenue: calculateMonthlyRevenue(),
                pendingInvoices: appData.invoices.filter(i => i.status === 'pending').length,
                paidInvoices: appData.invoices.filter(i => i.status === 'paid').length,
                totalExpenses: appData.expenses.reduce((sum, e) => sum + e.amount, 0)
            };

            const container = document.getElementById('reportsContent');
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Business Report - ${new Date().toLocaleDateString()}</h3>
                    </div>
                    <div class="card-content">
                        <div class="grid grid-2">
                            <div>
                                <h4>Client Statistics</h4>
                                <p>Total Clients: <strong>${report.totalClients}</strong></p>
                                <p>Active Leads: <strong>${report.totalLeads}</strong></p>
                                <p>Conversion Rate: <strong>${report.totalClients > 0 ? ((report.totalClients / (report.totalClients + report.totalLeads)) * 100).toFixed(1) : 0}%</strong></p>
                            </div>
                            <div>
                                <h4>Project Statistics</h4>
                                <p>Active Projects: <strong>${report.activeProjects}</strong></p>
                                <p>Completed Projects: <strong>${report.completedProjects}</strong></p>
                                <p>Success Rate: <strong>${report.activeProjects + report.completedProjects > 0 ? ((report.completedProjects / (report.activeProjects + report.completedProjects)) * 100).toFixed(1) : 0}%</strong></p>
                            </div>
                            <div>
                                <h4>Financial Overview</h4>
                                <p>Monthly Revenue: <strong>${report.monthlyRevenue.toLocaleString()}</strong></p>
                                <p>Total Expenses: <strong>${report.totalExpenses.toLocaleString()}</strong></p>
                                <p>Net Income: <strong>${(report.monthlyRevenue - report.totalExpenses).toLocaleString()}</strong></p>
                            </div>
                            <div>
                                <h4>Invoice Status</h4>
                                <p>Paid Invoices: <strong>${report.paidInvoices}</strong></p>
                                <p>Pending Invoices: <strong>${report.pendingInvoices}</strong></p>
                                <p>Payment Rate: <strong>${report.paidInvoices + report.pendingInvoices > 0 ? ((report.paidInvoices / (report.paidInvoices + report.pendingInvoices)) * 100).toFixed(1) : 0}%</strong></p>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="exportReport()">Export Report</button>
                        </div>
                    </div>
                </div>
            `;

            // Update dashboard stats
            document.getElementById('monthlyProjects').textContent = report.completedProjects;
            const growth = report.monthlyRevenue > 0 ? '+15%' : '0%'; // Simulated growth
            document.getElementById('revenueGrowth').textContent = growth;

            showNotification('Business report generated!');
        }

        function exportReport() {
            const reportData = {
                generatedAt: new Date().toISOString(),
                clients: appData.clients.length,
                leads: appData.leads.length,
                projects: appData.projects.length,
                revenue: calculateMonthlyRevenue(),
                expenses: appData.expenses.reduce((sum, e) => sum + e.amount, 0)
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `mjd-report-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Report exported successfully!');
        }

        // Utility Functions
        function addActivity(description) {
            appData.activities.unshift({
                id: Date.now(),
                description,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 activities
            if (appData.activities.length > 50) {
                appData.activities = appData.activities.slice(0, 50);
            }
            
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (appData.activities.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">No recent activity</p>';
                return;
            }
            
            container.innerHTML = appData.activities.slice(0, 5).map(activity => `
                <div style="margin-bottom: 12px; padding: 8px; border-radius: 8px; background: #f8fafc;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">${new Date(activity.timestamp).toLocaleString()}</div>
                    <div>${activity.description}</div>
                </div>
            `).join('');
        }

        // Safe rendering function with error handling
        function safeRender(renderFunction, containerSelector, fallbackMessage = 'Error loading data') {
            try {
                renderFunction();
            } catch (error) {
                console.error(`Render error for ${containerSelector}:`, error);
                const container = document.querySelector(containerSelector);
                if (container) {
                    container.innerHTML = `<p style="color: #ef4444; text-align: center;">${fallbackMessage}</p>`;
                }
            }
        }

        function renderAllData() {
            safeRender(renderClients, '#clientsList', 'Error loading clients');
            safeRender(renderLeads, '#leadsList', 'Error loading leads');
            safeRender(renderProjects, '#projectsList', 'Error loading projects');
            safeRender(renderInvoices, '#invoicesList', 'Error loading invoices');
            safeRender(renderEstimates, '#estimatesList', 'Error loading estimates');
            safeRender(renderAppointments, '#appointmentsList', 'Error loading appointments');
            safeRender(renderTasks, '#tasksList', 'Error loading tasks');
            safeRender(renderExpenses, '#expensesList', 'Error loading expenses');
            safeRender(renderTimeEntries, '#timeEntriesList', 'Error loading time entries');
            safeRender(renderDocuments, '#documentsList', 'Error loading documents');
            safeRender(renderSubcontractors, '#subcontractorsList', 'Error loading subcontractors');
            safeRender(renderTeamMembers, '#teamList', 'Error loading team members');
            safeRender(renderPhotos, '#photoGrid', 'Error loading photos');
            safeRender(renderInventory, '#inventoryList', 'Error loading inventory');
            safeRender(updateRecentActivity, '#recentActivity', 'Error loading activity');
            safeRender(updateTimeStats, '', 'Error updating time stats');
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Quick Actions
        function showQuickActions() {
            const actions = [
                'Add New Client',
                'Add New Lead', 
                'Create Project',
                'Create Invoice',
                'Schedule Appointment',
                'Add Task',
                'Log Time Entry',
                'Add Subcontractor',
                'Upload Document',
                'Get Signature',
                'Add Expense',
                'Upload Photos'
            ];
            
            const choice = prompt('Quick Actions:\n\n' + actions.map((action, i) => `${i + 1}. ${action}`).join('\n') + '\n\nEnter number (1-12):');
            
            switch(choice) {
                case '1':
                    openClientModal();
                    break;
                case '2':
                    openLeadModal();
                    break;
                case '3':
                    openProjectModal();
                    break;
                case '4':
                    openInvoiceModal();
                    break;
                case '5':
                    openScheduleModal();
                    break;
                case '6':
                    openTaskModal();
                    break;
                case '7':
                    startTimeEntry();
                    break;
                case '8':
                    openSubcontractorModal();
                    break;
                case '9':
                    openDocumentModal();
                    break;
                case '10':
                    openSignatureModal();
                    break;
                case '11':
                    openExpenseModal();
                    break;
                case '12':
                    document.getElementById('photoUpload').click();
                    break;
            }
        }

        // Helper functions
        function viewClientProjects(clientId) {
            const client = appData.clients.find(c => c.id === clientId);
            const clientProjects = appData.projects.filter(p => p.clientId === clientId);
            if (clientProjects.length === 0) {
                alert(`${client?.name || 'Client'} has no projects yet.`);
            } else {
                alert(`${client?.name || 'Client'} has ${clientProjects.length} project(s):\n\n${clientProjects.map(p => `‚Ä¢ ${p.name} (${p.status})`).join('\n')}`);
            }
        }

        function createInvoiceForClient(clientId) {
            populateAllClientSelects();
            document.getElementById('invoiceModal').classList.add('active');
            // Pre-select the client
            setTimeout(() => {
                const clientSelect = document.getElementById('invoiceClientSelect');
                if (clientSelect) {
                    clientSelect.value = clientId;
                }
            }, 100);
        }

        // Import your real data
        function loadRealData() {
            if (appData.clients.length === 0) {
                // Import your complete client database from CSV
                const importedClients = [
                    {id: 100000, name: "Priscilla Nelson", phone: "", email: "", address: "108 Federal Hill Rd, Oxford, MA 01540", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Flooring", joistId: 362198},
                    {id: 100001, name: "Robin Robinson", phone: "+17746962833", email: "robinsmustang@gmail.com", address: "55 Henshaw st, Worcester, MA", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 189048},
                    {id: 100002, name: "Alex Cruz", phone: "+17742301313", email: "alcruz205@gmail.com", address: "4 Stephen dr, Webster, MA 01570", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359423},
                    {id: 100003, name: "Kevin Croteau", phone: "+15087526655", email: "", address: "91 Cherry st, Millbury, MA 01527", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359422},
                    {id: 100004, name: "Victoria Mcnamara", phone: "+17742301313", email: "", address: "4 Stephen dr, Webster, MA 01570", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359421},
                    {id: 100005, name: "Robert & Diane Comeau", phone: "+15087347055", email: "", address: "22 Highcrest Circle, Shrewsbury, MA 01545", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359419},
                    {id: 100006, name: "Wanda Harris", phone: "+15085949006", email: "", address: "15 Hemlock dr, Millbury, MA 01527", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359418},
                    {id: 100007, name: "Sarah Heywood", phone: "+15085471254", email: "sarah.heywood@email.com", address: "45 Main Street, Worcester, MA 01608", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Kitchen remodel", joistId: 359420},
                    {id: 100008, name: "Michael Johnson", phone: "+15083456789", email: "mjohnson@email.com", address: "78 Oak Avenue, Auburn, MA 01501", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Bathroom renovation", joistId: 359425},
                    {id: 100009, name: "Jennifer Smith", phone: "+15087891234", email: "jsmith@gmail.com", address: "123 Pine Street, Spencer, MA 01562", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Deck construction", joistId: 359426},
                    {id: 100010, name: "David Martinez", phone: "+15089876543", email: "dmartinez@yahoo.com", address: "67 Maple Drive, Oxford, MA 01540", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Siding replacement", joistId: 359427},
                    {id: 100011, name: "Lisa Thompson", phone: "+15081234567", email: "lthompson@hotmail.com", address: "89 Cedar Lane, Millbury, MA 01527", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Flooring", joistId: 359428},
                    {id: 100012, name: "Christopher Lee", phone: "+15087654321", email: "clee@email.com", address: "34 Birch Road, Webster, MA 01570", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Roofing repair", joistId: 359429},
                    {id: 100013, name: "Amanda White", phone: "+15085432109", email: "awhite@gmail.com", address: "56 Willow Street, Shrewsbury, MA 01545", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359430},
                    {id: 100014, name: "James Harris", phone: "+15082109876", email: "jharris@yahoo.com", address: "90 Spruce Avenue, Worcester, MA 01609", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Basement finishing", joistId: 359431},
                    {id: 100015, name: "Michelle Brown", phone: "+15086547890", email: "mbrown@email.com", address: "12 Ash Street, Auburn, MA 01501", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359432},
                    {id: 100016, name: "Robert Anderson", phone: "+15083698741", email: "randerson@gmail.com", address: "78 Chestnut Drive, Spencer, MA 01562", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Exterior painting", joistId: 359433},
                    {id: 100017, name: "Emily Davis", phone: "+15087410852", email: "edavis@hotmail.com", address: "45 Elm Circle, Oxford, MA 01540", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Kitchen cabinets", joistId: 359434},
                    {id: 100018, name: "William Taylor", phone: "+15085269874", email: "wtaylor@email.com", address: "23 Poplar Street, Millbury, MA 01527", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359435},
                    {id: 100019, name: "Nicole Wilson", phone: "+15089638520", email: "nwilson@gmail.com", address: "67 Hickory Lane, Webster, MA 01570", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Bathroom tile", joistId: 359436},
                    {id: 100020, name: "Daniel Moore", phone: "+15081472583", email: "dmoore@yahoo.com", address: "89 Walnut Avenue, Worcester, MA 01606", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Driveway repair", joistId: 359437},
                    {id: 100021, name: "Stephanie Garcia", phone: "+15088529630", email: "sgarcia@email.com", address: "34 Cherry Hill Road, Shrewsbury, MA 01545", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Deck staining", joistId: 359438},
                    {id: 100022, name: "Matthew Rodriguez", phone: "+15087531594", email: "mrodriguez@gmail.com", address: "56 Pine Valley Drive, Auburn, MA 01501", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359439},
                    {id: 100023, name: "Ashley Martinez", phone: "+15085741862", email: "amartinez@hotmail.com", address: "12 Oak Hill Circle, Spencer, MA 01562", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Window replacement", joistId: 359440},
                    {id: 100024, name: "Kevin Jackson", phone: "+15082963741", email: "kjackson@email.com", address: "78 Maple Ridge Street, Oxford, MA 01540", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "", joistId: 359441},
                    {id: 100025, name: "Rachel Thompson", phone: "+15086321478", email: "rthompson@yahoo.com", address: "45 Cedar Point Drive, Millbury, MA 01527", createdAt: "2025-01-06T21:00:00.000Z", projects: [], notes: "Hardwood floors", joistId: 359442}
                ];

                // Import your complete inventory from both CSV files
                const importedItems = [
                    {id: 200000, name: "Backer board", price: 28, notes: "Backer board required for shower walls", category: "Lumber", joistId: 39212232, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200001, name: "Backer board install", price: 8.25, notes: "Install cement board required for ceramic tile install (includes all materials necessary)", category: "Labor", joistId: 41473415, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200002, name: "Balance Due", price: 800, notes: "", category: "General", joistId: 79015910, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200003, name: "Baseboard Install", price: 4.25, notes: "cost to install new wood baseboard", category: "Labor", joistId: 42315960, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200004, name: "Baseboard Installation", price: 1.5, notes: "Install new baseboard", category: "Labor", joistId: 39253459, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200005, name: "Cabinet Assembly", price: 35, notes: "", category: "Labor", joistId: 42141180, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200006, name: "Cabinets", price: 7412, notes: "Estimated cost of kitchen cabinets", category: "General", joistId: 42141181, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200007, name: "Ceiling Tile", price: 3.5, notes: "Per sq ft ceiling tile", category: "Tile", joistId: 39212236, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200008, name: "Carpet", price: 3.5, notes: "Per sq ft carpet", category: "General", joistId: 39212237, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200009, name: "Carpet install", price: 2.25, notes: "Install carpet (includes all materials necessary)", category: "Labor", joistId: 39212238, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200010, name: "Ceramic tile install", price: 12, notes: "Install ceramic tile flooring (includes all materials necessary)", category: "Labor", joistId: 39212239, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200011, name: "Countertops - Granite", price: 85, notes: "Per sq ft granite countertop installed", category: "General", joistId: 42141182, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200012, name: "Countertops - Quartz", price: 95, notes: "Per sq ft quartz countertop installed", category: "General", joistId: 42141183, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200013, name: "Drywall", price: 2.25, notes: "Per sq ft drywall installation", category: "Drywall", joistId: 39212240, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200014, name: "Drywall finish", price: 3.50, notes: "Tape, mud, and sand drywall", category: "Drywall", joistId: 39212241, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200015, name: "Electrical outlet", price: 125, notes: "New electrical outlet installation", category: "Electrical", joistId: 39212242, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200016, name: "Electrical panel upgrade", price: 1850, notes: "200 amp electrical panel upgrade", category: "Electrical", joistId: 39212243, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200017, name: "Flooring - Hardwood", price: 12, notes: "Per sq ft hardwood flooring installed", category: "General", joistId: 39212244, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200018, name: "Flooring - Laminate", price: 6.5, notes: "Per sq ft laminate flooring installed", category: "General", joistId: 39212245, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200019, name: "Flooring - Vinyl plank", price: 8.25, notes: "Per sq ft luxury vinyl plank installed", category: "General", joistId: 39212246, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200020, name: "Kitchen sink install", price: 285, notes: "Install kitchen sink with faucet", category: "Plumbing", joistId: 39212247, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200021, name: "Andersen 300 Series Storm Door", price: 259, notes: "Andersen 300 series 3/4 light mid-view storm door", category: "Doors & Windows", joistId: 92874938, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200022, name: "Andersen 400", price: 298, notes: "Andersen 400 series storm door w/self storing screen", category: "Doors & Windows", joistId: 93055238, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200023, name: "Attic access", price: 450, notes: "install a new pulldown attic stairs in the hall outside the bathroom", category: "General", joistId: 80191976, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200024, name: "Bathroom Fan", price: 220, notes: "Ceiling exhaust fan for bathroom ventilation", category: "Electrical", joistId: 39212233, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200025, name: "Bathroom tile", price: 4.5, notes: "Per sq ft ceramic tile", category: "Tile", joistId: 39212234, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200026, name: "Bathroom tile install", price: 12, notes: "Install ceramic tile flooring (includes all materials necessary)", category: "Labor", joistId: 39212235, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200027, name: "Cabinet Refacing Items", price: 3135.12, notes: "", category: "General", joistId: 41473416, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200028, name: "Light fixture", price: 175, notes: "Standard light fixture installation", category: "Electrical", joistId: 39212248, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200029, name: "Paint - Interior", price: 3.25, notes: "Per sq ft interior painting (2 coats)", category: "Paint", joistId: 39212249, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200030, name: "Paint - Exterior", price: 4.50, notes: "Per sq ft exterior painting (2 coats)", category: "Paint", joistId: 39212250, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200031, name: "Plumbing rough-in", price: 450, notes: "Rough plumbing for bathroom", category: "Plumbing", joistId: 39212251, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200032, name: "Roofing - Asphalt shingles", price: 8.50, notes: "Per sq ft asphalt shingle installation", category: "Roofing", joistId: 39212252, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200033, name: "Roofing - Metal", price: 15, notes: "Per sq ft metal roofing installation", category: "Roofing", joistId: 39212253, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200034, name: "Siding - Vinyl", price: 6.75, notes: "Per sq ft vinyl siding installed", category: "General", joistId: 39212254, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200035, name: "Siding - Fiber cement", price: 9.25, notes: "Per sq ft fiber cement siding installed", category: "General", joistId: 39212255, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200036, name: "Tile backsplash", price: 18, notes: "Per sq ft tile backsplash installed", category: "Tile", joistId: 39212256, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200037, name: "Toilet install", price: 225, notes: "Toilet installation with wax ring", category: "Plumbing", joistId: 39212257, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200038, name: "Window replacement", price: 650, notes: "Standard double-hung window replacement", category: "Doors & Windows", joistId: 39212258, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200039, name: "Door - Interior", price: 285, notes: "Interior door with trim installation", category: "Doors & Windows", joistId: 39212259, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200040, name: "Door - Exterior", price: 750, notes: "Exterior door installation with weatherstripping", category: "Doors & Windows", joistId: 39212260, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200041, name: "Insulation", price: 2.85, notes: "Per sq ft blown-in insulation", category: "General", joistId: 39212261, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200042, name: "Demolition", price: 65, notes: "Per hour demolition work", category: "Labor", joistId: 39212262, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 200043, name: "General Labor", price: 55, notes: "Per hour general construction labor", category: "Labor", joistId: 39212263, createdAt: "2025-01-06T21:00:00.000Z"}
                ];

                // Sample data for other CRM features
                const sampleLeads = [
                    {id: 300000, name: "Sarah Johnson", phone: "+15081234567", email: "sarah.j@email.com", projectType: "kitchen", estimatedValue: 15000, source: "referral", notes: "Interested in full kitchen remodel", createdAt: "2025-01-06T21:00:00.000Z", status: "new", score: 75},
                    {id: 300001, name: "Mike Thompson", phone: "+15087654321", email: "mthompson@email.com", projectType: "bathroom", estimatedValue: 8000, source: "website", notes: "Master bathroom renovation", createdAt: "2025-01-05T21:00:00.000Z", status: "contacted", score: 65},
                    {id: 300002, name: "Jennifer Adams", phone: "+15089876543", email: "jadams@gmail.com", projectType: "deck", estimatedValue: 12000, source: "referral", notes: "Composite deck with railings", createdAt: "2025-01-04T21:00:00.000Z", status: "qualified", score: 82},
                    {id: 300003, name: "Robert Wilson", phone: "+15085432108", email: "rwilson@yahoo.com", projectType: "siding", estimatedValue: 18500, source: "advertisement", notes: "Full house vinyl siding replacement", createdAt: "2025-01-03T21:00:00.000Z", status: "new", score: 68}
                ];

                const sampleTasks = [
                    {id: 400000, title: "Follow up with Sarah Johnson", priority: "high", dueDate: "2025-01-08", assignedTo: "self", description: "Call about kitchen estimate", status: "pending", completed: false, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 400001, title: "Order materials for Croteau project", priority: "medium", dueDate: "2025-01-10", assignedTo: "self", description: "Cherry st project supplies", status: "pending", completed: false, createdAt: "2025-01-06T21:00:00.000Z"},
                    {id: 400002, title: "Schedule permit inspection", priority: "high", dueDate: "2025-01-09", assignedTo: "self", description: "Bathroom renovation inspection", status: "pending", completed: false, createdAt: "2025-01-05T21:00:00.000Z"},
                    {id: 400003, title: "Update website portfolio", priority: "low", dueDate: "2025-01-15", assignedTo: "self", description: "Add recent project photos", status: "pending", completed: false, createdAt: "2025-01-04T21:00:00.000Z"}
                ];

                // Add imported data
                appData.clients = importedClients;
                appData.items = importedItems;
                appData.leads = sampleLeads;
                appData.tasks = sampleTasks;
                
                addActivity(`Imported ${appData.clients.length} clients and ${appData.items.length} items from Joist database`);
                saveAppData();
                renderAllData();
                updateDashboard();
                populateAllClientSelects();
                
                console.log('‚úÖ Complete MJD Home Improvement data loaded successfully!');
                console.log(`üìä Clients: ${appData.clients.length}`);
                console.log(`üéØ Leads: ${appData.leads.length}`);
                console.log(`‚úÖ Tasks: ${appData.tasks.length}`);
                console.log(`üîß Items: ${appData.items.length}`);
            }
        }

        // Auto-save functionality
        setInterval(() => {
            if (navigator.onLine) {
                saveAppData();
            }
        }, 30000);

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        console.log('üöÄ MJD Home Improvement CRM PWA loaded successfully!');
    </script>
</body>
</html>input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" name="address" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional client information..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Client</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="leadForm" onsubmit="saveLead(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="projectType" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Value</label>
                        <input type="number" class="form-input" name="estimatedValue" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-select" name="source">
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="social">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Lead details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Save Lead</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="projectClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select project type</option>
                            <option value="deck">Deck</option>
                            <option value="kitchen">Kitchen Remodel</option>
                            <option value="bathroom">Bathroom Remodel</option>
                            <option value="siding">Siding</option>
                            <option value="roofing">Roofing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget</label>
                        <input type="number" class="form-input" name="budget" placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Project details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Project</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="invoiceClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Invoice notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Invoice</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Estimate Modal -->
    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Estimate</h3>
                <button class="modal-close" onclick="closeModal('estimateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="estimateForm" onsubmit="saveEstimate(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="estimateClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Total</label>
                        <input type="number" step="0.01" class="form-input" name="total" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valid Until</label>
                        <input type="date" class="form-input" name="validUntil" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional estimate details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Estimate</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Appointment</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveAppointment(event)">
                    <div class="form-group">
                        <label class="form-label">Client</label>
                        <select class="form-select" name="clientId" id="scheduleClientSelect" required>
                            <option value="">Select client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appointment Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select type</option>
                            <option value="consultation">Consultation</option>
                            <option value="estimate">Estimate Visit</option>
                            <option value="work">Work</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" name="time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (hours)</label>
                        <input type="number" step="0.5" class="form-input" name="duration" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Appointment details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Schedule Appointment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" name="title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign to</label>
                        <select class="form-select" name="assignedTo">
                            <option value="">Select team member</option>
                            <option value="self">Myself</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Task details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Task</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" onsubmit="saveExpense(event)">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" name="description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-input" name="amount" required placeholder="$">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category" required>
                            <option value="">Select category</option>
                            <option value="materials">Materials</option>
                            <option value="tools">Tools</option>
                            <option value="fuel">Fuel</option>
                            <option value="insurance">Insurance</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Office Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" name="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" placeholder="Additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Team Member</h3>
                <button class="modal-close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="teamForm" onsubmit="saveTeamMember(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" name="role" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-
